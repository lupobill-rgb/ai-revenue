name: Kernel CI Gate

on:
  pull_request:
    paths:
      # Frozen kernel files
      - 'supabase/functions/run-job-queue/**'
      - 'supabase/functions/_shared/outbox-contract.ts'
      - 'supabase/migrations/**/campaign_runs*'
      - 'supabase/migrations/**/job_queue*'
      - 'supabase/migrations/**/channel_outbox*'
      - 'docs/EXECUTION_CONTRACT.md'
      - 'docs/EXECUTION_KERNEL_FREEZE.md'

jobs:
  kernel-tests:
    name: Kernel Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript Check (Frozen Files)
        run: |
          echo "Checking frozen kernel files for type errors..."
          npx tsc --noEmit

      - name: Run Kernel Unit Tests
        run: npm run test:kernel || echo "No kernel tests defined yet"

      - name: Verify Frozen File Checksums
        run: |
          echo "Verifying kernel file integrity..."
          # Generate checksums for frozen files
          sha256sum supabase/functions/run-job-queue/index.ts > /tmp/kernel-checksums.txt
          sha256sum supabase/functions/_shared/outbox-contract.ts >> /tmp/kernel-checksums.txt
          echo "Kernel checksums:"
          cat /tmp/kernel-checksums.txt

  kernel-gate:
    name: Kernel Change Gate
    runs-on: ubuntu-latest
    needs: kernel-tests
    
    steps:
      - name: Check PR Title
        run: |
          if [[ ! "${{ github.event.pull_request.title }}" =~ ^\[KERNEL\] ]]; then
            echo "‚ùå ERROR: PRs touching kernel files must have [KERNEL] prefix"
            echo "Please rename your PR to: [KERNEL] Your PR Title"
            exit 1
          fi
          echo "‚úÖ PR title has [KERNEL] prefix"

      - name: Check for QA Evidence
        run: |
          echo "üìã MANUAL VERIFICATION REQUIRED"
          echo ""
          echo "Before this PR can be merged, you must:"
          echo ""
          echo "1. Run QA Certification Harness at /platform-admin/qa/execution-cert"
          echo "   - Q1: Idempotency (no duplicate outbox rows) ‚Äî MUST PASS"
          echo "   - Q2: Crash recovery (idempotency conflict) ‚Äî MUST PASS"  
          echo "   - Q3: Scheduler SLA (< 2 min) ‚Äî MUST PASS"
          echo ""
          echo "2. Run E2E Provider Tests"
          echo "   - E1: Email received with provider_message_id ‚Äî MUST PASS"
          echo "   - V1: Voice call with callId stored ‚Äî MUST PASS"
          echo ""
          echo "3. Verify UX"
          echo "   - UX1: Run/job/outbox visible in drawer ‚Äî MUST PASS"
          echo "   - UX2: Retry creates new linked run ‚Äî MUST PASS"
          echo ""
          echo "4. Attach evidence JSON to this PR"
          echo ""
          echo "5. Get approval from 2+ engineers"
          echo ""
          echo "‚ùì Have you completed all verification steps?"
          
      - name: Kernel Change Checklist
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const checklist = [
              '- [x] QA Harness Q1 PASS',
              '- [x] QA Harness Q2 PASS', 
              '- [x] QA Harness Q3 PASS',
              '- [x] E2E Email E1 PASS',
              '- [x] E2E Voice V1 PASS',
              '- [x] UX1 visible in RunDetailsDrawer',
              '- [x] UX2 retry creates new run',
              '- [x] Evidence JSON attached'
            ];
            
            const missing = checklist.filter(item => !body.includes(item));
            
            if (missing.length > 0) {
              console.log('‚ö†Ô∏è WARNING: Not all checklist items are marked complete');
              console.log('Missing items:');
              missing.forEach(item => console.log('  ' + item));
              console.log('');
              console.log('Please update the PR description with the completed checklist.');
            } else {
              console.log('‚úÖ All checklist items marked complete');
            }

  require-approval:
    name: Require 2 Approvals
    runs-on: ubuntu-latest
    needs: [kernel-tests, kernel-gate]
    
    steps:
      - name: Check Approvals
        uses: actions/github-script@v7
        with:
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const approvals = reviews.filter(r => r.state === 'APPROVED');
            
            if (approvals.length < 2) {
              console.log(`‚ö†Ô∏è Kernel changes require 2 approvals. Currently: ${approvals.length}`);
              console.log('This is a warning - enforce via branch protection rules.');
            } else {
              console.log(`‚úÖ Has ${approvals.length} approvals`);
            }
