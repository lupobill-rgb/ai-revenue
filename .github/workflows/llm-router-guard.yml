name: LLM Router Guard

on:
  pull_request:
    paths:
      - 'supabase/functions/**'
      - 'src/**'

jobs:
  llm-router-checks:
    name: LLM Router Architecture Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^supabase/functions/' > .changed_supabase_functions.txt || touch .changed_supabase_functions.txt
          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^src/' > .changed_src.txt || touch .changed_src.txt

      - name: Guard vendor URLs stay behind adapters
        run: |
          set -euo pipefail
          if [ -s .changed_supabase_functions.txt ]; then
            cat .changed_supabase_functions.txt | xargs -d '\n' rg -n --no-messages \
              "ai\.gateway\.lovable\.dev|api\.openai\.com/v1|generativelanguage\.googleapis\.com" && {
                echo "ERROR: Vendor URLs must only exist in supabase/functions/_shared/providers/* (or be removed)."
                exit 1
              }
          fi

      - name: Guard provider SDK imports stay behind adapters
        run: |
          set -euo pipefail
          if [ -s .changed_supabase_functions.txt ]; then
            cat .changed_supabase_functions.txt | xargs -d '\n' rg -n --no-messages \
              "from ['\"]openai['\"]|@google/generative-ai|from ['\"]@google/generative-ai['\"]|from ['\"]anthropic['\"]|Anthropic\\b" && {
                echo "ERROR: Provider SDK imports must only exist in supabase/functions/_shared/providers/*."
                exit 1
              }
          fi

      - name: Guard frontend stays provider-agnostic
        run: |
          set -euo pipefail
          if [ -s .changed_src.txt ]; then
            cat .changed_src.txt | xargs -d '\n' rg -n --no-messages \
              "\\bOpenAI\\b|\\bGemini\\b|\\bClaude\\b|\\bAnthropic\\b|\\bopenai\\b|\\bgemini\\b|\\bclaude\\b|\\banthropic\\b|ai\.gateway" \
              --glob '!src/**/*.test.*' && {
                echo "ERROR: Frontend must not reference LLM providers or gateways."
                exit 1
              }
          fi
